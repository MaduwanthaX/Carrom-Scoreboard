<!doctype html>
<html lang=\"en\">
<head>
  <meta charset=\"utf-8\" />
  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />
  <title>Carrom Scoreboard</title>
  <script src=\"https://cdn.tailwindcss.com\"></script>
  <style>
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.7); }
    select { background-color: white; }
  </style>
</head>
<body class=\"bg-gradient-to-br from-rose-50 via-amber-50 to-sky-50 min-h-screen text-slate-900\">
  <div class=\"mx-auto max-w-3xl p-4\">
    <header class=\"rounded-2xl glass border p-4 mb-4 flex items-center justify-between shadow-sm\">
      <div class=\"flex items-center gap-3\">
        <div class=\"h-10 w-10 rounded-2xl bg-gradient-to-br from-rose-400 to-orange-300\"></div>
        <div>
          <h1 class=\"text-xl sm:text-2xl font-bold\">Carrom Scoreboard</h1>
          <div class=\"text-xs sm:text-sm text-slate-600\">Track wins & match history</div>
        </div>
      </div>
      <button id=\"openSettings\" class=\"text-sm px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 active:scale-95 transition\">Settings</button>
    </header>

    <div id=\"onboard\" class=\"hidden rounded-2xl border glass p-4 mb-4\">
      <div class=\"font-semibold mb-2\">Quick setup</div>
      <p class=\"text-sm mb-3\">Paste your Google Apps Script <b>/exec</b> URL to connect your sheet.</p>
      <button id=\"openSettings2\" class=\"px-3 py-2 rounded-xl bg-emerald-600 text-white\">Open Settings</button>
    </div>

    <div class=\"rounded-2xl glass border p-1 mb-4 flex gap-1 shadow-sm\">
      <button id=\"tab-scoreboard\" class=\"flex-1 px-3 py-2 rounded-xl bg-white\">Scoreboard</button>
      <button id=\"tab-new\" class=\"flex-1 px-3 py-2 rounded-xl\">New Match</button>
      <button id=\"tab-history\" class=\"flex-1 px-3 py-2 rounded-xl\">History</button>
    </div>

    <section id=\"view-scoreboard\" class=\"space-y-3\">
      <div id=\"sb-skeleton\" class=\"space-y-3\">
        <div class=\"h-16 rounded-xl glass border animate-pulse\"></div>
        <div class=\"h-16 rounded-xl glass border animate-pulse\"></div>
        <div class=\"h-16 rounded-xl glass border animate-pulse\"></div>
      </div>
    </section>

    <section id=\"view-new\" class=\"hidden space-y-4\">
      <div class=\"rounded-2xl border p-4 bg-white space-y-3\">
        <div class=\"flex items-center justify-between text-xs text-slate-600\">
          <div>Teams loaded: <span id=\"teamCount\">0</span></div>
          <button id=\"reloadTeams\" class=\"px-2 py-1 rounded-lg border bg-white active:scale-95 transition\">Reload teams</button>
        </div>
        <div id=\"fetchError\" class=\"hidden text-xs text-rose-600\"></div>
        <div class=\"grid grid-cols-1 sm:grid-cols-2 gap-3\">
          <div>
            <label class=\"block text-sm mb-1\">Date</label>
            <input id=\"date\" type=\"date\" class=\"w-full border rounded-xl px-3 py-2 bg-white\" />
          </div>
          <div></div>
          <div>
            <label class=\"block text-sm mb-1\">Team A</label>
            <select id=\"teamA\" class=\"w-full border rounded-xl px-3 py-2\">
              <option value=\"\" disabled selected>Choose Team A</option>
            </select>
          </div>
          <div>
            <label class=\"block text-sm mb-1\">Team B</label>
            <select id=\"teamB\" class=\"w-full border rounded-xl px-3 py-2\">
              <option value=\"\" disabled selected>Choose Team B</option>
            </select>
          </div>
        </div>
        <div id=\"teamWarn\" class=\"text-xs text-rose-600\"></div>
        <div id=\"emptyTeams\" class=\"hidden text-xs text-amber-700\">No teams loaded. Tap <b>Settings</b>, paste your <code>/exec</code> URL, then tap <b>Reload teams</b>.</div>
      </div>

      <div class=\"rounded-2xl border p-4 bg-white\">
        <div class=\"flex items-center justify-between mb-2\">
          <div class=\"font-semibold\">Rounds</div>
          <div class=\"flex gap-2\">
            <button id=\"addRound\" class=\"px-3 py-2 rounded-xl border bg-white active:scale-95 transition\">Add Round</button>
            <button id=\"removeRound\" class=\"px-3 py-2 rounded-xl border bg-white active:scale-95 transition\">Remove Round</button>
          </div>
        </div>
        <div id=\"rounds\" class=\"space-y-2\"></div>
      </div>

      <div class=\"flex items-center justify-between\">
        <div id=\"totals\" class=\"text-sm text-slate-700\"></div>
        <button id=\"save\" class=\"px-4 py-2 rounded-xl bg-emerald-600 text-white active:scale-95 transition\" disabled>Save Match</button>
      </div>
      <div id=\"saveMsg\" class=\"text-sm text-emerald-700\"></div>
    </section>

    <section id=\"view-history\" class=\"hidden space-y-3\">
      <div id=\"hist-skeleton\" class=\"space-y-3\">
        <div class=\"h-20 rounded-xl glass border animate-pulse\"></div>
        <div class=\"h-20 rounded-xl glass border animate-pulse\"></div>
      </div>
    </section>

    <div id=\"settingsPanel\" class=\"fixed inset-0 hidden z-50\">
      <div class=\"absolute inset-0 bg-black/30\" id=\"closeSettings\"></div>
      <div class=\"absolute right-0 top-0 h-full w-full sm:w-[28rem] bg-white shadow-2xl p-4 overflow-auto\">
        <div class=\"flex items-center justify-between mb-3\">
          <h2 class=\"text-lg font-semibold\">Settings</h2>
          <button id=\"closeSettingsBtn\" class=\"text-sm px-2 py-1 rounded-lg border\">Close</button>
        </div>
        <div class=\"space-y-3\">
          <div>
            <label class=\"block text-sm mb-1\">Google Apps Script Web App URL (works with either <code>script.google.com/.../exec</code> or <code>script.googleusercontent.com/...macros/echo?... </code>)</label>
            <input id=\"apiUrl\" type=\"url\" class=\"w-full border rounded-xl px-3 py-2\" placeholder=\"https://script.google.com/macros/s/.../exec\" />
          </div>
          <div>
            <label class=\"block text-sm mb-1\">Optional token (if you secure your web app)</label>
            <input id=\"apiToken\" type=\"text\" class=\"w-full border rounded-xl px-3 py-2\" placeholder=\"leave blank if not used\" />
          </div>
          <div class=\"flex gap-2\">
            <button id=\"saveSettings\" class=\"px-3 py-2 rounded-xl bg-emerald-600 text-white\">Save</button>
            <a id=\"openBackend\" class=\"px-3 py-2 rounded-xl border\" href=\"#\" target=\"_blank\">Open backend</a>
          </div>
          <p id=\"settingsMsg\" class=\"text-sm text-emerald-700\"></p>
        </div>
      </div>
    </div>

    <footer class=\"mt-8 text-center text-xs text-slate-500\">
      Made for evening carrom fun üèÜ
    </footer>
  </div>

<script>
const store = {
  get url() { return localStorage.getItem('carrom_api_url') || ''; },
  set url(v) { localStorage.setItem('carrom_api_url', v); },
  get token() { return localStorage.getItem('carrom_api_token') || ''; },
  set token(v) { localStorage.setItem('carrom_api_token', v); }
};
const qs = s => document.querySelector(s);
const ce = (tag, cls='') => { const e = document.createElement(tag); if (cls) e.className = cls; return e; };

let teams = [];
let matches = [];
let wins = {};

const views = {
  scoreboard: document.getElementById('view-scoreboard'),
  new: document.getElementById('view-new'),
  history: document.getElementById('view-history'),
};

function show(name) {
  for (const k in views) views[k].classList.toggle('hidden', k !== name);
  for (const id of ['tab-scoreboard','tab-new','tab-history']) {
    const active = ('tab-' + name) === id;
    document.getElementById(id).classList.toggle('bg-white', active);
  }
}

function withTokenUrl(rawUrl) {
  const u = new URL(rawUrl);
  if (store.token) u.searchParams.set('token', store.token);
  return u;
}

async function apiGet(action) {
  if (!store.url) throw new Error('Set your /exec URL in Settings.');
  const u = new URL(store.url);
  u.searchParams.set('action', action);
  const res = await fetch(withTokenUrl(u.toString()));
  const text = await res.text();
  try { return JSON.parse(text); }
  catch { throw new Error('Non-JSON response: ' + text.slice(0, 200)); }
}

async function apiPost(form) {
  if (!store.url) throw new Error('Set your /exec URL in Settings.');
  if (store.token) form.append('token', store.token);
  const res = await fetch(store.url, { method:'POST', body: form });
  const text = await res.text();
  try { return JSON.parse(text); }
  catch { throw new Error('Non-JSON response: ' + text.slice(0, 200)); }
}

function renderScoreboard() {
  const root = views.scoreboard;
  root.innerHTML = '';
  teams.forEach((t, i) => {
    const card = ce('div', 'rounded-2xl glass border p-4 flex items-center justify-between shadow-sm');
    const left = ce('div', 'flex items-center gap-3');
    const dot = ce('div', 'h-4 w-4 rounded-full ' + ['bg-rose-400','bg-amber-400','bg-sky-400'][i % 3]);
    const name = ce('div', 'font-semibold'); name.textContent = t.name;
    left.append(dot, name);
    const badge = ce('div', 'px-3 py-1 rounded-xl bg-white text-slate-700'); badge.textContent = 'Wins: ' + (wins[t.id] || 0);
    card.append(left, badge);
    root.append(card);
  });
  qs('#sb-skeleton').classList.add('hidden');
}

function renderHistory() {
  const root = views.history;
  root.innerHTML = '';
  const nameOf = id => (teams.find(t => t.id === Number(id)) || {}).name || ('Team ' + id);
  matches.slice().reverse().forEach(m => {
    const card = ce('div', 'rounded-2xl glass border p-4 space-y-1 shadow-sm');
    const h = ce('div', 'font-semibold'); h.textContent = `${m.date} ‚Äî ${nameOf(m.teamAId)} vs ${nameOf(m.teamBId)}`;
    const tot = ce('div'); tot.textContent = `Totals: ${m.teamATotal} - ${m.teamBTotal}`;
    const rounds = JSON.parse(m.roundsJson || '[]');
    const rl = ce('div', 'text-sm text-slate-700');
    rl.innerHTML = rounds.map((r,i)=>`‚Ä¢ Round ${i+1}: ${r[0]} - ${r[1]}`).join('<br>');
    card.append(h, rl, tot);
    root.append(card);
  });
  qs('#hist-skeleton').classList.add('hidden');
}

function populateTeamSelects() {
  const a = document.getElementById('teamA'), b = document.getElementById('teamB');
  const oldA = a.value, oldB = b.value;
  a.innerHTML=''; b.innerHTML='';
  const phA = ce('option'); phA.value=''; phA.text='Choose Team A'; phA.disabled=true; phA.selected=true; a.append(phA);
  const phB = ce('option'); phB.value=''; phB.text='Choose Team B'; phB.disabled=true; phB.selected=true; b.append(phB);
  teams.forEach(t => {
    const o1 = ce('option'); o1.value = t.id; o1.textContent = t.name; a.append(o1);
    const o2 = ce('option'); o2.value = t.id; o2.textContent = t.name; b.append(o2);
  });
  document.getElementById('teamCount').textContent = String(teams.length);
  document.getElementById('emptyTeams').classList.toggle('hidden', teams.length > 0);
  if (teams.find(t=>String(t.id)===oldA)) a.value = oldA;
  if (teams.find(t=>String(t.id)===oldB)) b.value = oldB;
  updateSaveEnabled();
}

function updateTotals() {
  const rounds = Array.from(document.querySelectorAll('.round-row')).map(row => {
    const a = Number(row.querySelector('.ra').value || 0);
    const b = Number(row.querySelector('.rb').value || 0);
    return [a,b];
  });
  const aTot = rounds.reduce((s,r)=>s+r[0],0);
  const bTot = rounds.reduce((s,r)=>s+r[1],0);
  const aName = document.getElementById('teamA').selectedOptions[0]?.textContent || 'A';
  const bName = document.getElementById('teamB').selectedOptions[0]?.textContent || 'B';
  qs('#totals').textContent = `Totals ‚Üí ${aName}: ${aTot} | ${bName}: ${bTot}`;
}

function updateSaveEnabled() {
  const a = document.getElementById('teamA').value;
  const b = document.getElementById('teamB').value;
  const warn = document.getElementById('teamWarn');
  const save = document.getElementById('save');
  if (!a || !b) { warn.textContent = 'Pick both teams.'; save.disabled = true; return; }
  if (a === b) { warn.textContent = 'Teams must be different.'; save.disabled = true; return; }
  warn.textContent = ''; save.disabled = false;
}

function addRoundRow(a=0,b=0) {
  const row = ce('div','round-row grid grid-cols-3 gap-2');
  const label = ce('div','self-center'); label.textContent = `Round ${document.querySelectorAll('.round-row').length+1}`;
  const ia = ce('input','ra border rounded-xl px-3 py-2 bg-white'); ia.type='number'; ia.min='0'; ia.value=a; ia.oninput=()=>{ updateTotals(); };
  const ib = ce('input','rb border rounded-xl px-3 py-2 bg-white'); ib.type='number'; ib.min='0'; ib.value=b; ib.oninput=()=>{ updateTotals(); };
  row.append(label, ia, ib);
  qs('#rounds').append(row);
  updateTotals();
}

document.getElementById('tab-scoreboard').onclick = () => { show('scoreboard'); refresh(); };
document.getElementById('tab-new').onclick = () => { show('new'); refresh(); };
document.getElementById('tab-history').onclick = () => { show('history'); refresh(); };
document.getElementById('reloadTeams').onclick = () => { refresh(); };

document.getElementById('addRound').onclick = () => addRoundRow(0,0);
document.getElementById('removeRound').onclick = () => {
  const rows = document.querySelectorAll('.round-row');
  if (rows.length > 1) rows[rows.length-1].remove();
  updateTotals();
};
document.getElementById('teamA').onchange = ()=>{ updateTotals(); updateSaveEnabled(); };
document.getElementById('teamB').onchange = ()=>{ updateTotals(); updateSaveEnabled(); };

document.getElementById('save').onclick = async () => {
  try {
    const date = qs('#date').value || new Date().toISOString().slice(0,10);
    const teamAId = qs('#teamA').value;
    const teamBId = qs('#teamB').value;
    if (!teamAId || !teamBId || teamAId === teamBId) return;
    const rounds = Array.from(document.querySelectorAll('.round-row')).map(row => {
      const a = Number(row.querySelector('.ra').value || 0);
      const b = Number(row.querySelector('.rb').value || 0);
      return [a,b];
    });
    const body = new URLSearchParams();
    body.append('action','addMatch');
    body.append('date', date);
    body.append('teamAId', teamAId);
    body.append('teamBId', teamBId);
    body.append('rounds', JSON.stringify(rounds));
    const j = await apiPost(body);
    document.getElementById('saveMsg').textContent = j.ok ? 'Saved!' : ('Error: ' + (j.error || 'unknown'));
    await refresh();
    show('scoreboard');
  } catch (e) {
    alert(e.message || e);
  }
};

function openSettings() {
  qs('#apiUrl').value = store.url;
  qs('#apiToken').value = store.token;
  const base = store.url ? (new URL(store.url).toString()) : '#';
  const u = new URL(base); u.searchParams.set('action','getAll'); if (store.token) u.searchParams.set('token', store.token);
  qs('#openBackend').href = u.toString();
  document.getElementById('settingsPanel').classList.remove('hidden');
}
function closeSettings() { document.getElementById('settingsPanel').classList.add('hidden'); }
document.getElementById('openSettings').onclick = openSettings;
document.getElementById('openSettings2').onclick = openSettings;
document.getElementById('closeSettings').onclick = closeSettings;
document.getElementById('closeSettingsBtn').onclick = closeSettings;

document.getElementById('saveSettings').onclick = (ev) => {
  ev.preventDefault();
  store.url = qs('#apiUrl').value.trim();
  store.token = qs('#apiToken').value.trim();
  qs('#settingsMsg').textContent = 'Saved!';
  setTimeout(()=>{ qs('#settingsMsg').textContent=''; closeSettings(); refresh(); }, 300);
};

async function refresh() {
  try {
    document.getElementById('fetchError').classList.add('hidden');
    const data = await apiGet('getAll');
    teams = data.teams || [];
    matches = data.matches || [];
    wins = data.wins || {};
    renderScoreboard();
    renderHistory();
    populateTeamSelects();
    updateTotals();
    updateSaveEnabled();
  } catch (e) {
    console.warn('Refresh failed:', e);
    document.getElementById('fetchError').textContent = 'Error: ' + (e.message || e);
    document.getElementById('fetchError').classList.remove('hidden');
    document.getElementById('emptyTeams').classList.remove('hidden');
  }
}

(function init(){
  const params = new URLSearchParams(location.search);
  const pApi = params.get('api'); if (pApi) store.url = pApi;
  const pTok = params.get('token'); if (pTok) store.token = pTok;

  document.getElementById('date').value = new Date().toISOString().slice(0,10);
  addRoundRow(0,0);
  show('scoreboard');

  if (!store.url) {
    document.getElementById('onboard').classList.remove('hidden');
  } else {
    refresh();
  }
})();
</script>
</body>
</html>
