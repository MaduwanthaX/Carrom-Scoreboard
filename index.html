<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Carrom Teams ‚Äî Cloud (Stats + Confetti + Login)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
  html, body { height: 100%; }
  .card { border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 4px 16px rgba(0,0,0,0.06); }
  .btn { transition: transform .05s ease; }
  .btn:active { transform: scale(.98); }

  .team-name { font-size: 1.15rem; }
  @media (min-width: 640px) { .team-name { font-size: 1.35rem; } }
  .team-score { font-size: 2rem; line-height: 1; }
  @media (min-width: 640px) { .team-score { font-size: 2.5rem; } }
  .team-members { font-size: 0.95rem; }

  .topCard { outline: 2px solid #f59e0b; box-shadow: 0 8px 30px rgba(245,158,11,.25); position: relative; padding-right: 76px !important; }
  .topBadge { position: absolute; top: -8px; right: -8px; width: 40px; height: 40px; z-index: 10;
              border-radius: 9999px; background:
              radial-gradient(circle at 30% 30%, #fff8, #0000),
              linear-gradient(135deg, #fde047, #f59e0b 60%, #d97706);
              display:flex; align-items:center; justify-content:center;
              box-shadow: 0 6px 18px rgba(0,0,0,.15); }
  .topBadge svg { width: 20px; height: 20px; }
  @keyframes spinRing { from { transform: rotate(0); } to { transform: rotate(360deg); } }
  .ring { position:absolute; inset:-3px; border-radius:9999px; border:3px dashed rgba(0,0,0,.12); animation: spinRing 6s linear infinite; }
</style>
</head>
<body class="min-h-screen bg-gradient-to-br from-amber-50 via-rose-50 to-sky-50 text-slate-900">
  <div class="mx-auto max-w-5xl px-4 py-4">
    <header class="card rounded-2xl p-4 mb-4 flex items-center justify-between bg-white">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-rose-400 to-orange-300"></div>
        <div>
          <h1 class="text-2xl font-bold">Carrom Teams</h1>
          <p class="text-sm text-slate-600">Google Sheet backend ‚Äî players give points to their own team</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="openSettings" class="btn px-3 py-2 rounded-xl border bg-white text-sm">Settings</button>
      </div>
    </header>

    <div class="card rounded-2xl p-1 mb-4 bg-white flex gap-1">
      <button id="tab-score" class="flex-1 px-3 py-2 rounded-xl bg-white">Scoreboard</button>
      <button id="tab-new" class="flex-1 px-3 py-2 rounded-xl">New Match</button>
      <button id="tab-hist" class="flex-1 px-3 py-2 rounded-xl">History</button>
      <button id="tab-stats" class="flex-1 px-3 py-2 rounded-xl">Stats</button>
    </div>

    <!-- Scoreboard -->
    <section id="view-score" class="space-y-3">
      <div id="teamsGrid" class="grid grid-cols-1 sm:grid-cols-3 gap-3"></div>
      <div id="topNote" class="text-center text-sm text-amber-700"></div>
    </section>

    <!-- New Match -->
    <section id="view-new" class="hidden space-y-4">
      <div class="card rounded-2xl p-4 bg-white space-y-3">
        <div class="text-base text-slate-700">
          Pick four distinct players, place them into Side A and Side B (two per side), then choose the winner.
          Each winning player adds <span id="ptsPerHeadLabel">5</span> points to their own team.
          <span class="font-medium text-rose-700">Each losing player subtracts 5 points from their own team.</span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="space-y-2">
            <div class="font-semibold text-base">All Players</div>
            <div id="playersList" class="flex flex-wrap gap-2"></div>
          </div>
          <div class="space-y-2">
            <div class="font-semibold text-base">Side A</div>
            <div class="grid grid-cols-2 gap-2">
              <select id="a1" class="border rounded-xl px-3 py-2 bg-white"></select>
              <select id="a2" class="border rounded-xl px-3 py-2 bg-white"></select>
            </div>
            <div class="text-sm text-slate-500">Winner?</div>
            <div class="flex gap-4 text-base">
              <label class="flex items-center gap-2"><input type="radio" name="winner" value="A"> <span>Side A</span></label>
              <label class="flex items-center gap-2"><input type="radio" name="winner" value="B"> <span>Side B</span></label>
            </div>

            <!-- Inline winner preview -->
            <div id="matchPreview" class="mt-2 text-base">
              <div class="hidden rounded-xl border bg-white px-3 py-2" id="matchPreviewBox">
                <div class="font-medium">Preview</div>
                <div id="matchPreviewText" class="text-slate-800"></div>
              </div>
            </div>
          </div>
          <div class="space-y-2">
            <div class="font-semibold text-base">Side B</div>
            <div class="grid grid-cols-2 gap-2">
              <select id="b1" class="border rounded-xl px-3 py-2 bg-white"></select>
              <select id="b2" class="border rounded-xl px-3 py-2 bg-white"></select>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <button id="swapSides" class="btn border rounded-xl px-3 py-2 bg-white">Swap</button>
              <button id="clearMatch" class="btn border rounded-xl px-3 py-2 bg-white">Clear</button>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div>
            <label class="block text-base mb-1">Points per winning player (loss penalty is fixed at 5)</label>
            <input id="ptsPerHead" type="number" min="1" value="5" class="border rounded-xl px-3 py-2 bg-white w-full">
          </div>
          <div>
            <label class="block text-base mb-1">Date</label>
            <input id="matchDate" type="date" class="border rounded-xl px-3 py-2 bg-white w-full">
          </div>
          <div class="flex items-end">
            <button id="saveMatch" class="btn px-4 py-2 rounded-xl bg-emerald-600 text-white w-full text-base">Save Match</button>
          </div>
        </div>
        <div id="warn" class="text-base text-rose-600"></div>
      </div>
    </section>

    <!-- History -->
    <section id="view-hist" class="hidden space-y-3">
      <div id="histList" class="space-y-3"></div>
    </section>

    <!-- Stats -->
    <section id="view-stats" class="hidden space-y-4">
      <div class="card rounded-2xl p-4 bg-white">
        <h2 class="text-xl font-semibold mb-3">Team Stats</h2>
        <div id="teamStats" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
      </div>
      <div class="card rounded-2xl p-4 bg-white">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold">Player Leaderboard (MVP)</h2>
          <div class="text-sm text-slate-600" id="totalMatches"></div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr class="text-sm text-slate-600">
                <th class="py-2">#</th>
                <th class="py-2">Player</th>
                <th class="py-2">Team</th>
                <th class="py-2">Points</th>
                <th class="py-2">Played</th>
                <th class="py-2">Wins</th>
                <th class="py-2">Win rate</th>
                <th class="py-2">Avg pts / match</th>
              </tr>
            </thead>
            <tbody id="playerTable" class="text-base"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Settings side panel -->
    <div id="settingsPanel" class="fixed inset-0 hidden z-50">
      <div class="absolute inset-0 bg-black/30" id="closeSettings"></div>
      <div class="absolute right-0 top-0 h-full w-full sm:w-[28rem] bg-white shadow-2xl p-4 overflow-auto">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Settings</h2>
          <button id="closeSettingsBtn" class="text-sm px-2 py-1 rounded-lg border">Close</button>
        </div>
        <div class="space-y-3">
          <div>
            <label class="block text-sm mb-1">Google Apps Script Web App URL</label>
            <input id="apiUrl" type="url" class="w-full border rounded-xl px-3 py-2" placeholder="https://script.google.com/macros/s/.../exec OR https://script.googleusercontent.com/...macros/echo?..."/>
          </div>
          <div>
            <label class="block text-sm mb-1">Optional token (if you secure your web app)</label>
            <input id="apiToken" type="text" class="w-full border rounded-xl px-3 py-2" placeholder="leave blank if not used" />
          </div>
          <div class="flex gap-2">
            <button id="saveSettings" class="px-3 py-2 rounded-xl bg-emerald-600 text-white">Save</button>
            <a id="openBackend" class="px-3 py-2 rounded-xl border" href="#" target="_blank">Open backend</a>
            <button id="logoutBtn" class="ml-auto px-3 py-2 rounded-xl border text-sm">Logout</button>
          </div>
          <p id="settingsMsg" class="text-sm text-emerald-700"></p>
          <div class="text-xs text-slate-500">Tip: You can also pass <code>?api=YOUR_EXEC_URL</code> in the page URL.</div>
        </div>
      </div>
    </div>

    <!-- Login panel -->
    <div id="loginPanel" class="fixed inset-0 hidden z-50">
      <div class="absolute inset-0 bg-black/40"></div>
      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="w-full max-w-sm card bg-white rounded-2xl p-5 space-y-3">
          <h3 class="text-lg font-semibold">Login required</h3>
          <p class="text-sm text-slate-600">Enter your credentials to access the New Match tab.</p>
          <div class="space-y-2">
            <div>
              <label class="block text-sm mb-1">Username</label>
              <input id="loginUser" class="w-full border rounded-xl px-3 py-2" placeholder="Username">
            </div>
            <div>
              <label class="block text-sm mb-1">Password</label>
              <input id="loginPass" type="password" class="w-full border rounded-xl px-3 py-2" placeholder="Password">
            </div>
          </div>
          <div class="flex gap-2">
            <button id="loginBtn" class="px-3 py-2 rounded-xl bg-emerald-600 text-white">Login</button>
            <button id="loginCancel" class="px-3 py-2 rounded-xl border">Cancel</button>
          </div>
          <div id="loginMsg" class="text-sm text-rose-600"></div>
        </div>
      </div>
    </div>

    <footer class="mt-8 text-center text-sm text-slate-500">
      Built for evening carrom fun üèÜ
    </footer>
  </div>

<script>
const store = {
  get url() { return localStorage.getItem('carrom_api_url') || ''; },
  set url(v) { localStorage.setItem('carrom_api_url', v); },
  get token() { return localStorage.getItem('carrom_api_token') || ''; },
  set token(v) { localStorage.setItem('carrom_api_token', v); },
  get auth() { return localStorage.getItem('carrom_auth') === '1'; },
  set auth(v) { localStorage.setItem('carrom_auth', v ? '1' : '0'); }
};
const DEFAULT_API = "https://script.google.com/macros/s/AKfycbzJPeUHtuJmUxz_X-HwXFuQnZ4HvmjWmKxHHuHu-GGN9jz7v7-6ODMC9Km9GlbZSMjX/exec";
const LOGIN_USER = "Maduwantha";
const LOGIN_PASS = "senadeerastores";

// --- Rule config ---
const LOSS_PENALTY = 5;   // fixed deduction per losing player

const qs = s => document.querySelector(s);
const ce = (tag, cls='') => { const e = document.createElement(tag); if (cls) e.className = cls; return e; };

let TEAMS = [];
let SCORES = {};
let HISTORY = [];
let ALL_PLAYERS = [];
let playerToTeamId = {};
let PREV_TOP = null;
let afterLogin = null;

function buildUrl(base, extraParams) {
  const u = new URL(base);
  for (const [k, v] of Object.entries(extraParams || {})) u.searchParams.set(k, v);
  if (store.token) u.searchParams.set('token', store.token);
  return u.toString();
}
async function apiGet(action) {
  if (!store.url) throw new Error('Set your Web App URL in Settings.');
  const url = buildUrl(store.url, { action });
  const res = await fetch(url);
  const text = await res.text();
  try { return JSON.parse(text); }
  catch { throw new Error('Non-JSON response: ' + text.slice(0, 180)); }
}
async function apiPost(form) {
  if (!store.url) throw new Error('Set your Web App URL in Settings.');
  if (store.token) form.append('token', store.token);
  const res = await fetch(store.url, { method:'POST', body: form });
  const text = await res.text();
  try { return JSON.parse(text); }
  catch { throw new Error('Non-JSON response: ' + text.slice(0, 180)); }
}

const views = { score: qs('#view-score'), new: qs('#view-new'), hist: qs('#view-hist'), stats: qs('#view-stats') };
function setTab(name) {
  for (const [k, el] of Object.entries(views)) el.classList.toggle('hidden', k !== name);
  qs('#tab-score').classList.toggle('bg-white', name==='score');
  qs('#tab-new').classList.toggle('bg-white', name==='new');
  qs('#tab-hist').classList.toggle('bg-white', name==='hist');
  qs('#tab-stats').classList.toggle('bg-white', name==='stats');
}

function setsEqual(a, b) {
  if (!a || !b) return false;
  if (a.size !== b.size) return false;
  for (const v of a) if (!b.has(v)) return false;
  return true;
}

function fireConfettiForTeam(teamId) {
  const card = document.querySelector(`[data-team-id="${teamId}"]`);
  const rect = card ? card.getBoundingClientRect() : null;
  let originX = 0.5, originY = 0.2;
  if (rect) {
    originX = (rect.left + rect.width/2) / window.innerWidth;
    originY = (rect.top + 10) / window.innerHeight;
  }
  const burst = (particleCount, spread) => {
    confetti({ particleCount, spread, origin: { x: originX, y: originY }, startVelocity: 45, gravity: 0.9 });
  };
  burst(55, 55);
  setTimeout(()=>burst(40, 70), 150);
  setTimeout(()=>burst(28, 90), 300);
}

// ---- Live scores with always-on penalty ----
function computeLiveScores() {
  const scores = {};
  TEAMS.forEach(t => { scores[t.id] = 0; });

  HISTORY.forEach(h => {
    const a = [h.a1, h.a2].filter(Boolean);
    const b = [h.b1, h.b2].filter(Boolean);
    const winners = (h.winnerSide === 'A') ? a : b;
    const losers  = (h.winnerSide === 'A') ? b : a;
    const pts = Number(h.pointsPerHead || 5);

    winners.forEach(p => {
      const tid = playerToTeamId[p];
      if (tid) scores[tid] = (scores[tid] || 0) + pts;
    });
    // Always subtract for losers
    losers.forEach(p => {
      const tid = playerToTeamId[p];
      if (tid) scores[tid] = (scores[tid] || 0) - LOSS_PENALTY;
    });
  });

  return scores;
}

// ---------- Winner preview ----------
function teamNameById(tid) {
  const t = TEAMS.find(x => x.id === tid);
  return t ? t.name : '‚Äî';
}
function computeMatchPreview() {
  const a1 = qs('#a1').value, a2 = qs('#a2').value, b1 = qs('#b1').value, b2 = qs('#b2').value;
  const winner = (document.querySelector('input[name="winner"]:checked')||{}).value;
  const pts = Math.max(1, Number(qs('#ptsPerHead').value || 5));

  // sync header label
  qs('#ptsPerHeadLabel').textContent = pts;

  const okPlayers = a1 && a2 && b1 && b2;
  const okWinner  = winner === 'A' || winner === 'B';
  const box = qs('#matchPreviewBox');
  const txt = qs('#matchPreviewText');

  if (!okPlayers || !okWinner) { box.classList.add('hidden'); txt.textContent = ''; return; }

  const winners = (winner === 'A') ? [a1, a2] : [b1, b2];
  const losers  = (winner === 'A') ? [b1, b2] : [a1, a2];

  const teamDelta = {};
  const addDelta = (player, delta) => {
    const tid = playerToTeamId[player];
    if (!tid) return;
    teamDelta[tid] = (teamDelta[tid] || 0) + delta;
  };

  winners.forEach(p => addDelta(p, pts));
  losers.forEach(p => addDelta(p, -LOSS_PENALTY)); // always subtract

  const entries = Object.entries(teamDelta)
    .sort((a,b) => b[1]-a[1])
    .map(([tid, delta]) => `${teamNameById(tid)} ${delta > 0 ? '+' : ''}${delta}`);

  // Quick headline if both pairs are same-team
  const winnersTeams = [...new Set(winners.map(p => playerToTeamId[p]).filter(Boolean))];
  const losersTeams  = [...new Set(losers.map(p  => playerToTeamId[p]).filter(Boolean))];
  let headline = '';
  if (winnersTeams.length === 1 && losersTeams.length === 1) {
    const winTid = winnersTeams[0], loseTid = losersTeams[0];
    const winSum  = winners.reduce((s,p) => s + (playerToTeamId[p]===winTid ? pts : 0), 0);
    const loseSum = losers.reduce((s,p)=> s + (playerToTeamId[p]===loseTid ? LOSS_PENALTY : 0), 0);
    headline = `${teamNameById(winTid)} +${winSum}, ${teamNameById(loseTid)} -${loseSum} (${losers.length} ${losers.length===1?'player':'players'})`;
  }

  const lines = [];
  if (headline) lines.push(headline);
  lines.push(entries.join(', '));

  box.classList.remove('hidden');
  txt.textContent = lines.join('  ‚Ä¢  ');
}

function renderScoreboard() {
  const grid = qs('#teamsGrid'); grid.innerHTML = '';
  const live = computeLiveScores();
  const scoresArr = TEAMS.map(t => live[t.id] || 0);
  const max = Math.max(0, ...scoresArr);
  const topSet = new Set(TEAMS.filter(t => (live[t.id] || 0) === max && max > 0).map(t => t.id));

  TEAMS.forEach((t, i) => {
    const isTop = topSet.has(t.id);
    const card = ce('div', 'card rounded-2xl bg-white p-4 space-y-2 ' + (isTop ? 'topCard' : ''));
    card.dataset.teamId = t.id;
    const header = ce('div', 'flex items-start justify-between');
    const left = ce('div', 'flex items-center gap-2');
    const dot = ce('div', 'h-3 w-3 rounded-full ' + ['bg-rose-400','bg-amber-400','bg-sky-400'][i%3]);
    const name = ce('div', 'team-name font-semibold'); name.textContent = t.name;
    left.append(dot, name);
    const score = ce('div', 'team-score font-extrabold'); score.textContent = live[t.id] || 0;
    header.append(left, score);
    card.append(header);
    const members = ce('div', 'team-members text-slate-600'); members.textContent = (t.members||[]).join(' & ');
    card.append(members);
    if (isTop) {
      const badge = ce('div','topBadge');
      badge.innerHTML = '<div class="ring"></div><svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17l-4 2 1-4-3-3 4-.5L12 7l2 4.5 4 .5-3 3 1 4-4-2z"/></svg>';
      card.append(badge);
    }
    grid.append(card);
  });

  const note = qs('#topNote');
  if (max > 0) {
    const topNames = TEAMS.filter(t => topSet.has(t.id)).map(t => t.name).join(' & ');
    note.textContent = topSet.size > 1 ? `Top: tie ‚Äî ${topNames}` : `Top: ${topNames}`;
  } else note.textContent = '';

  if (PREV_TOP === null) {
    PREV_TOP = new Set(topSet);
  } else {
    const singleLeaderNow = topSet.size === 1;
    const changed = !setsEqual(PREV_TOP, topSet);
    if (singleLeaderNow && changed) {
      const leaderId = [...topSet][0];
      fireConfettiForTeam(leaderId);
    }
    PREV_TOP = new Set(topSet);
  }
}

function rebuildPlayerLists() {
  ALL_PLAYERS = [...new Set(TEAMS.flatMap(t => t.members || []))].sort();
  playerToTeamId = {};
  TEAMS.forEach(t => (t.members||[]).forEach(m => playerToTeamId[m]=t.id));

  const list = qs('#playersList'); list.innerHTML = '';
  ALL_PLAYERS.forEach(p => {
    const b = ce('button', 'px-3 py-1 rounded-full border bg-white text-sm btn'); b.textContent = p;
    b.onclick = () => addPlayerToNextSlot(p);
    list.append(b);
  });
  for (const id of ['a1','a2','b1','b2']) {
    const sel = qs('#'+id);
    sel.innerHTML = '<option value="">--</option>' + ALL_PLAYERS.map(p=>`<option value="${p}">${p}</option>`).join('');
    sel.onchange = enforceDistinctPlayers;
  }
}
function enforceDistinctPlayers() {
  const chosen = new Set(['a1','a2','b1','b2'].map(id => qs('#'+id).value).filter(Boolean));
  for (const id of ['a1','a2','b1','b2']) {
    const sel = qs('#'+id);
    const cur = sel.value;
    Array.from(sel.options).forEach(opt => {
      if (!opt.value) return;
      opt.disabled = (opt.value !== cur && chosen.has(opt.value));
    });
  }
  computeMatchPreview();
}
function addPlayerToNextSlot(p) {
  for (const id of ['a1','a2','b1','b2']) {
    const sel = qs('#'+id);
    if (!sel.value) { sel.value = p; enforceDistinctPlayers(); return; }
  }
}
function clearMatch() {
  ['a1','a2','b1','b2'].forEach(id => qs('#'+id).value='');
  enforceDistinctPlayers();
  document.querySelectorAll('input[name="winner"]').forEach(r => r.checked=false);
  qs('#warn').textContent = '';
  computeMatchPreview();
}
function swapSides() {
  const a1 = qs('#a1').value, a2 = qs('#a2').value, b1 = qs('#b1').value, b2 = qs('#b2').value;
  qs('#a1').value = b1; qs('#a2').value = b2; qs('#b1').value = a1; qs('#b2').value = a2;
  enforceDistinctPlayers();
}

// ---------- Stats ----------
function computeStats() {
  const teamStats = {};
  TEAMS.forEach(t => teamStats[t.id] = {
    id:t.id, name:t.name, members:t.members||[],
    matches:0, winCredits:0, points:0, longestStreak:0, currentStreak:0
  });
  const playerStats = {};
  ALL_PLAYERS.forEach(p => playerStats[p] = { player:p, team:playerToTeamId[p], matches:0, wins:0, points:0, longestStreak:0, currentStreak:0 });

  HISTORY.forEach(h => {
    const a = [h.a1,h.a2].filter(Boolean);
    const b = [h.b1,h.b2].filter(Boolean);
    const winners = (h.winnerSide==='A') ? a : b;
    const losers  = (h.winnerSide==='A') ? b : a;
    const pts = Number(h.pointsPerHead || 5);

    TEAMS.forEach(t => {
      const plays = a.concat(b).some(p => (playerToTeamId[p]===t.id));
      if (plays) teamStats[t.id].matches += 1;
    });

    const teamWinnersCount = {};
    winners.forEach(p => {
      const tid = playerToTeamId[p]; if (!tid) return;
      teamStats[tid].points += pts;
      teamWinnersCount[tid] = (teamWinnersCount[tid]||0) + 1;
    });

    // Always subtract for each losing player
    losers.forEach(p => {
      const tid = playerToTeamId[p]; if (!tid) return;
      teamStats[tid].points -= LOSS_PENALTY;
    });

    TEAMS.forEach(t => {
      const winCount = (teamWinnersCount[t.id]||0);
      const credit = winCount * 0.5;
      if (credit > 0) {
        teamStats[t.id].winCredits += credit;
        teamStats[t.id].currentStreak += 1;
        teamStats[t.id].longestStreak = Math.max(teamStats[t.id].longestStreak, teamStats[t.id].currentStreak);
      } else {
        teamStats[t.id].currentStreak = 0;
      }
    });

    const participants = a.concat(b);
    participants.forEach(p => { if (playerStats[p]) playerStats[p].matches += 1; });
    winners.forEach(p => {
      if (!playerStats[p]) return;
      playerStats[p].wins += 1;
      playerStats[p].points += pts;
      playerStats[p].currentStreak += 1;
      playerStats[p].longestStreak = Math.max(playerStats[p].longestStreak, playerStats[p].currentStreak);
    });
    losers.forEach(p => {
      if (!playerStats[p]) return;
      playerStats[p].currentStreak = 0;           // reset streak on loss
      playerStats[p].points -= LOSS_PENALTY;      // always subtract
    });
  });

  Object.values(teamStats).forEach(s => {
    s.winRate = s.matches ? (s.winCredits / s.matches) : 0;
    s.avgPoints = s.matches ? (s.points / s.matches) : 0;
  });
  Object.values(playerStats).forEach(s => {
    s.winRate = s.matches ? (s.wins / s.matches) : 0;
    s.avgPoints = s.matches ? (s.points / s.matches) : 0;
  });

  return { teamStats, playerStats };
}

function renderStats() {
  const { teamStats, playerStats } = computeStats();
  const live = computeLiveScores();

  const grid = qs('#teamStats'); grid.innerHTML = '';
  TEAMS.forEach((t, i) => {
    const s = teamStats[t.id];
    const card = ce('div','card rounded-2xl p-4 bg-white space-y-2');
    const head = ce('div','flex items-center justify-between');
    const left = ce('div','flex items-center gap-2');
    const dot = ce('div','h-3 w-3 rounded-full ' + ['bg-rose-400','bg-amber-400','bg-sky-400'][i%3]);
    const name = ce('div','font-semibold text-lg'); name.textContent = t.name;
    left.append(dot, name);
    const points = ce('div','text-2xl font-extrabold'); points.textContent = Math.round(live[t.id] || 0);
    head.append(left, points);
    card.append(head);

    const row = ce('div','grid grid-cols-2 gap-2 text-sm text-slate-700');
    row.innerHTML = `
      <div><span class="text-slate-500">Matches:</span> ${s.matches}</div>
      <div><span class="text-slate-500">Win rate:</span> ${(s.winRate*100).toFixed(0)}%</div>
      <div><span class="text-slate-500">Avg pts/match:</span> ${s.avgPoints.toFixed(1)}</div>
      <div><span class="text-slate-500">Longest streak:</span> ${s.longestStreak}</div>
    `;
    card.append(row);
    grid.append(card);
  });

  const totalMatches = HISTORY.length;
  qs('#totalMatches').textContent = `${totalMatches} matches`;
  const tbody = qs('#playerTable'); tbody.innerHTML = '';
  const rows = Object.values(playerStats)
    .sort((a,b) => b.points - a.points || b.wins - a.wins)
    .map((s, idx) => `
      <tr class="border-t">
        <td class="py-2">${idx+1}</td>
        <td class="py-2">${s.player}</td>
        <td class="py-2">${(TEAMS.find(t=>t.id===s.team)||{}).name || '-'}</td>
        <td class="py-2 font-semibold">${s.points}</td>
        <td class="py-2">${s.matches}</td>
        <td class="py-2">${s.wins}</td>
        <td class="py-2">${(s.winRate*100).toFixed(0)}%</td>
        <td class="py-2">${s.avgPoints.toFixed(1)}</td>
      </tr>
    `).join('');
  tbody.innerHTML = rows || '<tr><td class="py-3" colspan="8">No matches yet.</td></tr>';
}

function renderHistory() {
  const root = qs('#histList'); root.innerHTML = '';
  const items = HISTORY.slice().reverse();
  if (!items.length) {
    const empty = ce('div','card rounded-2xl bg-white p-4 text-base text-slate-600'); empty.textContent = 'No matches saved yet.'; root.append(empty); return;
  }
  items.forEach(m => {
    const card = ce('div','card rounded-2xl bg-white p-4 space-y-1');
    const line = ce('div','font-semibold text-base'); line.textContent = `${m.date} ‚Äî ${m.a1} & ${m.a2} vs ${m.b1} & ${m.b2} ‚Äî Winner: ${m.winnerSide}`;
    const award = ce('div','text-base text-slate-700'); award.textContent = `Awarded +${m.pointsPerHead} to: ${m.winners}`;
    card.append(line, award);

    // Always show penalty line for losers
    const losers = (m.winnerSide === 'A') ? [m.b1, m.b2].filter(Boolean) : [m.a1, m.a2].filter(Boolean);
    if (losers.length) {
      const penalty = ce('div','text-base text-rose-700');
      penalty.textContent = `Penalized ‚àí${LOSS_PENALTY} from: ${losers.join(' & ')}`;
      card.append(penalty);
    }

    const teamsAward = ce('div','text-sm text-slate-600'); teamsAward.textContent = `Team awards: ${m.teamAwardSummary}`;
    card.append(teamsAward); root.append(card);
  });
}

function openLogin(next) {
  afterLogin = next || null;
  qs('#loginMsg').textContent = '';
  qs('#loginUser').value = '';
  qs('#loginPass').value = '';
  qs('#loginPanel').classList.remove('hidden');
  setTimeout(()=>qs('#loginUser').focus(), 50);
}
function closeLogin() { qs('#loginPanel').classList.add('hidden'); }

function tryLogin() {
  const u = (qs('#loginUser').value || '').trim();
  const p = (qs('#loginPass').value || '').trim();
  if (u === LOGIN_USER && p === LOGIN_PASS) {
    store.auth = true;
    closeLogin();
    if (typeof afterLogin === 'function') afterLogin();
    afterLogin = null;
  } else {
    qs('#loginMsg').textContent = 'Invalid username or password.';
  }
}

async function saveMatch() {
  if (!store.auth) { openLogin(() => setTab('new')); return; }
  const a1 = qs('#a1').value, a2 = qs('#a2').value, b1 = qs('#b1').value, b2 = qs('#b2').value;
  const winner = (document.querySelector('input[name="winner"]:checked')||{}).value;
  const pts = Math.max(1, Number(qs('#ptsPerHead').value||5));
  qs('#ptsPerHeadLabel').textContent = pts;

  if (!a1 || !a2 || !b1 || !b2) { qs('#warn').textContent = 'Please select four distinct players.'; return; }
  if (!winner) { qs('#warn').textContent = 'Please choose the winning side.'; return; }

  const date = qs('#matchDate').value || new Date().toISOString().slice(0,10);
  const body = new URLSearchParams();
  body.append('action','addMatch');
  body.append('date', date);
  body.append('a1', a1); body.append('a2', a2);
  body.append('b1', b1); body.append('b2', b2);
  body.append('winnerSide', winner);
  body.append('pointsPerHead', String(pts));

  try {
    const j = await apiPost(body);
    if (!j.ok) throw new Error(j.error || 'Unknown error');
    qs('#warn').textContent = 'Saved!';
    await refreshAll();
    setTab('score');
  } catch (e) {
    qs('#warn').textContent = 'Error: ' + (e.message || e);
  }
}

// Settings panel
function openSettings() {
  qs('#apiUrl').value = store.url;
  qs('#apiToken').value = store.token;
  qs('#openBackend').href = store.url ? buildUrl(store.url, { action:'getAll' }) : '#';
  qs('#settingsPanel').classList.remove('hidden');
}
function closeSettings() { qs('#settingsPanel').classList.add('hidden'); }
qs('#openSettings').onclick = openSettings;
qs('#closeSettings').onclick = closeSettings;
qs('#closeSettingsBtn').onclick = closeSettings;
qs('#saveSettings').onclick = (ev) => {
  ev.preventDefault();
  store.url = qs('#apiUrl').value.trim();
  store.token = qs('#apiToken').value.trim();
  qs('#settingsMsg').textContent = 'Saved!';
  setTimeout(()=>{ qs('#settingsMsg').textContent=''; closeSettings(); refreshAll(); }, 300);
};
qs('#logoutBtn').onclick = () => { store.auth = false; alert('Logged out.'); };

// Login events
qs('#loginBtn').onclick = tryLogin;
qs('#loginCancel').onclick = () => { closeLogin(); };

async function refreshAll() {
  try {
    const data = await apiGet('getAll');
    TEAMS = data.teams || [];
    SCORES = data.scores || {};   // kept for compatibility; UI uses computeLiveScores()
    HISTORY = data.history || [];
    rebuildPlayerLists();
    renderScoreboard();
    renderHistory();
    renderStats();
    const today = new Date().toISOString().slice(0,10);
    qs('#matchDate').value = today;
    qs('#matchDate').setAttribute('max', today); // prevent future dates
    enforceDistinctPlayers();
    computeMatchPreview(); // initial preview compute
  } catch (e) {
    alert('Backend error: ' + (e.message || e));
  }
}

qs('#tab-score').onclick = () => setTab('score');
qs('#tab-new').onclick = () => { if (store.auth) setTab('new'); else openLogin(() => setTab('new')); };
qs('#tab-hist').onclick = () => setTab('hist');
qs('#tab-stats').onclick = () => { renderStats(); setTab('stats'); };
qs('#swapSides').onclick = swapSides;
qs('#clearMatch').onclick = clearMatch;
qs('#saveMatch').onclick = saveMatch;

// Live winner preview triggers
document.querySelectorAll('input[name="winner"]').forEach(r => {
  r.addEventListener('change', computeMatchPreview);
});
['a1','a2','b1','b2'].forEach(id => qs('#'+id).addEventListener('change', computeMatchPreview));
qs('#ptsPerHead').addEventListener('input', computeMatchPreview);
qs('#matchDate').addEventListener('change', computeMatchPreview);

(function init(){
  setTab('score');
  const params = new URLSearchParams(location.search);
  const pApi = params.get('api'); if (pApi) store.url = pApi;
  const pTok = params.get('token'); if (pTok) store.token = pTok;
  if (!store.url) store.url = DEFAULT_API; // default for convenience
  if (store.url) refreshAll();
})();
</script>
</body>
</html>
